#! /bin/env ruby
#
# Copyright 2011-2012 Shinichiro Takizawa
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#


##############################################################################
# Environment Configuration
##############################################################################
RVPE_LOCATION = ENV['RVPE_LOCATION']

if !RVPE_LOCATION
  $stderr.puts 'set "RVPE_LOCATION" valiable.'
  exit 1
else
  RUBY_LIB_LOCATION = RVPE_LOCATION + '/lib'
end

$: << RUBY_LIB_LOCATION

##############################################################################
# Required libraries
##############################################################################
require 'renkei-vpe-tool/cli-utilities'
require 'renkei-vpe-tool/admin-helper/resource_generator'
require 'optparse'

include RenkeiVPETool::CliUtilities

##############################################################################
# Constant variables
##############################################################################
CMD_NAME = 'rscparse'
CMD_HELP = <<EOS
NAME
    #{CMD_NAME} - parser for resource files for RENKEI-VPE

Synopsis
    #{CMD_NAME} <command> [ options ] <input_file>

Description
    This command parses CSV-formatted resource files into RENKEI-VPE's
    YAML-formatted resource files.

    The <command> is a name of a subcommand of #{CMD_NAME} command.

Commands
    zone [ -o <output_file> ] <zone_file> [ <network_file> ... ]
        Parse a zone file.   It will output the zone resource definition
        to standard output if optional '-o' option is not specified.  If
        '-o' option is specified,  the output will be  written  in  the
        <output_file>.

        When optional <network_file> ... are specified, it will generate
        a zone definition with virtual network definition.

        A zone file must be formatted in CSV as follow.

            ZONE_NAME, tokyo_tech
            DESCRIPTION, Tokyo Institute of Technology
            SERVERS, hpci-vms00-in.r.gsic.titech.ac.jp, \\
                     hpci-vms01-in.r.gsic.titech.ac.jp

        A network file must be formatted in CSV as follow.

            NETWORK_NAME, csi-grid
            DESCRIPTION, CSI-Grid VPN in Tokyo Institute of Technology
            ZONE_NAME, tokyo_tech
            ADDRESS, 210.146.72.0
            NETMASK, 255.255.252.0
            GATEWAY, 210.146.75.254
            DNS_SERVERS, 210.146.74.243
            NTP_SERVERS, 210.146.75.200, 210.146.75.201
            BRIDGE, br5
            VM_HOSTS
            vm00.g.gsic.titech.ac.jp, 210.146.75.204
            vm01.g.gsic.titech.ac.jp, 210.146.75.205

        $ #{CMD_NAME} zone tokyo_tech.txt
        $ #{CMD_NAME} zone -o tokyo_tech_zone.def tokyo_tech.txt
        $ #{CMD_NAME} zone -o tokyo_tech_zone.def tokyo_tech.txt \\
        > csi_grid.txt

        Once you get a zone definition generated by this command,  you
        can define the zone in RENKEI-VPE by  executing the following
        command.

        $ rvpezone create tokyo_tech_zone.def

    vnet [ -o <output_file> ] <network_file>
        Parse a virtual network file. It will output the virtual network
        resource definition to starndard output if optional  '-o' option
        is not specified.  If '-o' option is specified,  the output will
        be written in the <output_file>.

        The format of a network file is the same written  in the above
        'zone' section.

        $ #{CMD_NAME} vnet tokyo_tech_csi_grid.txt
        $ #{CMD_NAME} vnet -o tokyo_tech_csi_grid.def \\
        > tokyo_tech_csi_gridn.txt

        Once you get a virtual network definition  generated  by this
        command, you can define the network in RENKEI-VPE by executing
        the following command.

        $ rvpezone addvnet tokyo_tech tokyo_tech_csi_grid.def

    help
        Show this message.

Options
EOS

##############################################################################
# Global variables
##############################################################################
output = STDOUT
rscgen = RenkeiVPETool::AdminHelper::ResourceGenerator.new

##############################################################################
# main
##############################################################################
begin
  parser = OptionParser.new
  parser.banner = CMD_HELP

  parser.on('-o OUTPUT_FILE', ': write to a file') do |file|
    output = File.open(file, 'w')
  end

  parser.on('-h', '--help', ': Show this message') do
    puts parser.help
    exit 0
  end

  parser.parse!(ARGV)
  raise 'Error: Specify command.' if ARGV.empty?
rescue OptionParser::ParseError => e
  exit_on_parse_error(e.message)
rescue => e
  exit_on_parse_error(e.message)
end

command = ARGV.shift
case command
when 'zone'
  check_command('zone', 1)
  begin
    output.puts rscgen.gen_zone_with_vnet(*(ARGV.map {|e| File.open(e).read}))
  rescue => e
    $stderr.puts 'Error: ' + e.message
  end

when 'vnet'
  check_command('vnet', 1)
  begin
    output.puts rscgen.gen_vnet(File.open(ARGV.shift).read)
  rescue => e
    $stderr.puts 'Error: ' + e.message
  end

when 'help'
  puts parser.help

else
  exit_on_parse_error("Unknown command: #{command}")

end


# Local Variables:
# mode: Ruby
# coding: utf-8
# indent-tabs-mode: nil
# End:
